# Azure pipeline to deploy a Function App to one or more environments
# This pipeline deploys the structure (including service plan and storage account).
# The Function App is used by the Logic App workflows to send customised emails via GovNotify.

trigger: none

pr: none

variables:
- template: variables/pipeline-vars-common.yml

resources:
  pipelines:
  - pipeline: ci-func-app-pipeline
    source: rle-payment-statement-func-app-ci

stages:
- stage: DEV
  displayName: 'DEV Deployment'
  variables:
  - template: variables/pipeline-vars-dev.yml
  jobs:
  - template: templates/template-iac-funcapp.yml
    parameters:
      environment: ${{ variables.envShortName }}
      serviceConnection: ${{ variables.serviceConnection }}
      runId: $(resources.pipeline.ci-func-app-pipeline.runID)

- stage: TEST
  displayName: 'TEST Deployment'
  variables:
  - template: variables/pipeline-vars-test.yml
  jobs:
  - template: templates/template-iac-funcapp.yml
    parameters:
      environment: ${{ variables.envShortName }}
      serviceConnection: ${{ variables.serviceConnection }}
      runId: $(resources.pipeline.ci-func-app-pipeline.runID)
