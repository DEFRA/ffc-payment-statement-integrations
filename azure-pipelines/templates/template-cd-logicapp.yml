# Logic App workflows deployment template

parameters:
- name: environment
  type: string
- name: serviceConnection
  type: string
- name: runId
  type: string
- name: settingsFile
  type: string
- name: connectionsFile
  type: string
- name: keyVaultName
  type: string

jobs:
  - deployment: deploy_logicapp_resources
    displayName: Deploy Logic App
    pool:
      vmImage: ubuntu-latest
    environment: ${{ parameters.environment }}
    variables:
      deploymentMode: 'Incremental'
      artifactPath: '$(Pipeline.Workspace)/cipipeline/$(artifactName)'
    strategy:
      runOnce:
        deploy:
          steps:
          - bash: |
              unzip -q '${{ variables.artifactPath}}/${{ parameters.runID }}.zip' -d ./unpacked
            displayName: Unzip artifact

          - bash: |
              echo "##vso[task.setvariable variable=settingsJson]$(cat ./unpacked/${{ parameters.settingsFile }} | tr -d '\n')"
            displayName: 'Read settings for environment ${{ parameters.environment }}'

          - task: AzureAppServiceSettings@1
            displayName: Azure App Service Settings
            inputs:
              azureSubscription: ${{ parameters.serviceConnection}}
              appName: $(logicAppName)
              resourceGroupName: $(resourceGroupName)
              appSettings: $(settingsJson)

          - bash: |
              cd ./unpacked
              cp ${{ parameters.connectionsFile }} connections.json
              zip -r newArtifact.zip *
            displayName: 'Use environment-specific connections.json - create new artifact'

          - task: AzureFunctionApp@2
            displayName: 'Deploy logic app workflows'
            inputs:
              azureSubscription: ${{ parameters.serviceConnection }}
              appType: 'functionApp'
              appName: $(logicAppName)
              package: './unpacked/newArtifact.zip'
              deploymentMethod: 'zipDeploy'

          - task: AzureKeyVault@2
            inputs:
              azureSubscription: ${{ parameters.serviceConnection }}
              KeyVaultName: ${{ parameters.keyVaultName }}
              SecretsFilter: '*'
              RunAsPreJob: false

          - task: AzureCLI@2
            inputs:
              azureSubscription: ${{ parameters.serviceConnection }}
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az resource show --name $(logicAppName) --resource-group  $(resourceGroupName) --resource-type "Microsoft.Web/sites" --query "identity" > tempId.json
                echo "##vso[task.setvariable variable=logicAppSystemAssignedIdentityObjectId]$(cat tempId.json | grep 'principalId' | tr -d ',' | awk '{ print $2; }' | tr -d '"')"
                echo "##vso[task.setvariable variable=logicAppSystemAssignedIdentityTenantId]$(cat tempId.json | grep 'tenantId' | tr -d ',' | awk '{ print $2; }' | tr -d '"')"
                rm tempId.json
              addSpnToEnvironment: true
              useGlobalConfig: true
            displayName: 'Read System-Assigned Managed Identity from config'

          - task: AzureResourceGroupDeployment@2
            displayName: 'Deploy Connectors'
            inputs:
              azureSubscription: ${{ parameters.serviceConnection }}
              resourceGroupName: $(resourceGroupName)
              location: $(resourceGroupLocation)
              csmFile: './unpacked/templates/connectors-template.json'
              overrideParameters:
                -location $(resourceGroupLocation)
                -connections_servicebus_name_sp $(servicebusConnectionNameSP)
                -servicebus_connection_string_sp $(ServiceBusConnectionStringDev)
                -connections_servicebus_name_api $(servicebusConnectionNameAPI)
                -servicebus_connection_string_api $(ServiceBusConnectionStringDev)
                -serviceBusUserManagedIdentityTenantId $(ServiceBusUserManagedIdentityTenantIdDev)
                -serviceBusUserManagedIdentityObjectId $(ServiceBusUserManagedIdentityObjectIdDev)
                -logicAppSystemAssignedIdentityTenantId $(logicAppSystemAssignedIdentityTenantId)
                -logicAppSystemAssignedIdentityObjectId $(logicAppSystemAssignedIdentityObjectId)
                -dataverse_connection_name_api $(dataverseConnectionNameAPI)
                -service_principal_client_id $(ServicePrincipalClientId)
                -service_principal_client_secret $(ServicePrincipalClientSecret)
                -service_principal_tenant_id $(ServicePrincipalTenantId)
              deploymentMode: $(deploymentMode)

          - task: ARM Outputs@6
            displayName: 'ARM Outputs Connectors'
            inputs:
              ConnectedServiceNameSelector: 'ConnectedServiceNameARM'
              ConnectedServiceNameARM: ${{ parameters.serviceConnection }}
              resourceGroupName: $(resourceGroupName)
              whenLastDeploymentIsFailed: 'fail'

          - task: AzureCLI@2
            displayName: 'App Settings for Connectors'
            inputs:
              azureSubscription: ${{ parameters.serviceConnection }}
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az functionapp config appsettings set --name $(logicAppName) --resource-group  $(resourceGroupName) --settings "BLOB_CONNECTION_RUNTIMEURL=$(blobendpointurl)"
                az functionapp config appsettings set --name $(logicAppName) --resource-group  $(resourceGroupName) --settings "SERVICEBUS_CONNECTION_SP_RUNTIMEURL=$(servicebusendpointurlsp)"
                az functionapp config appsettings set --name $(logicAppName) --resource-group  $(resourceGroupName) --settings "SERVICEBUS_CONNECTION_API_RUNTIMEURL=$(servicebusendpointurlapi)"
              addSpnToEnvironment: true
              useGlobalConfig: true
